@page "/explore"
@using Devella.Components.Layout.LoggedIn
@using Devella.DataAccessLayer.DTOs.UserAccess
@using Devella.Interfaces
@using DevellaLib.Helpers
@layout AuthenticatedLayout
@inject IDeveloperProvider DeveloperProvider

<PageTitle>Utforska</PageTitle>

<section id="explore-container">
    <div class="search-filter-wrapper">
        <div class="search-container">
            <input type="text" class="form-control search-input" placeholder="Sök användare, kompetenser..." @bind="searchTerm" @oninput="FilterProfiles" />
            <span class="search-icon">
                <i class="fa-solid fa-magnifying-glass"></i>
            </span>
        </div>

        <div class="filter-icon">
            <i class="fa-solid fa-filter" @onclick="ToggleFilterDropdown"></i>
            @if (showFilterDropdown)
            {
                <ul class="dropdown-menu show" @onclick:stopPropagation="true">
                    @foreach (var option in sortOptions)
                    {
                        <li>
                            <a class="dropdown-item @(selectedSortOption == option ? "active" : "")"
                               @onclick="() => ApplySortOption(option)">
                                @option
                            </a>
                        </li>
                    }
                    @if (!string.IsNullOrEmpty(selectedSortOption))
                    {
                        <li><hr class="dropdown-divider" /></li>
                        <li>
                            <a class="dropdown-item text-danger" @onclick="ClearSortOption">
                                Clear Filter
                            </a>
                        </li>
                    }
                </ul>
            }
        </div>
    </div>

    @if (profiles != null)
    {
        @foreach (var profile in profiles)
        {
            <div class="profile-card">
                <h3>@profile.FirstName @profile.Surname</h3>
                <p>@profile.Description</p>
                <p><strong>Erfarenhet:</strong> @profile.Experience år</p>
                <div>
                    <strong>Färdigheter: </strong>
                    @if (profile.Competence != null)
                    {
                        @foreach (var comp in profile.Competence.Qualifications)
                        {
                            <span class="badge bg-secondary">@EnumHelper.GetDisplayName(comp)</span>
                        }
                        @foreach (var area in profile.Competence.CompetenceAreas)
                        {
                            <span class="badge bg-secondary">@EnumHelper.GetDisplayName(area)</span>
                        }
                        @foreach (var lang in profile.Competence.ProgrammingLanguages)
                        {
                            <span class="badge bg-secondary">@EnumHelper.GetDisplayName(lang)</span>
                        }
                        @foreach (var level in profile.Competence.CompetenceLevel)
                        {
                            <span class="badge bg-secondary">@EnumHelper.GetDisplayName(level)</span>
                        }
                    }
                </div>
            </div>
        }
    }
    @if (totalPages >= 2)
    {
        <p class="d-flex justify-content-center mt-3">
            Visar @(((currentPage - 1) * pageSize) + 1)-@Math.Min(currentPage * pageSize, totalRows) av @totalRows projekt
        </p>
    }

    <div class="pagination-buttons d-flex justify-content-center">
        <button class="btn btn-secondary me-2" @onclick="PreviousPage" disabled="@(currentPage == 1)"><i class="fa-solid fa-chevron-left"></i></button>
        <span>Sida @currentPage av @totalPages</span>
        <button class="btn btn-secondary ms-2" @onclick="NextPage" disabled="@(currentPage == totalPages)"><i class="fa-solid fa-chevron-right"></i></button>
    </div>
   
</section>

@code {
    private bool isLoading = false;
    private List<DeveloperProfileDTO> profiles = new();
    private List<DeveloperProfileDTO> allProfiles = new();


    // Pagination properties
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 0;
    private int totalRows = 0;

    // Sorting properties
    private string searchTerm = "";
    private bool showFilterDropdown = false;
    private string selectedSortOption = "";
    private List<string> sortOptions = new() { "Anställningsform", "Erfarenhet" };

    protected override async Task OnInitializedAsync()
    {
        await LoadProfilesAsync();
    }

    private async Task LoadProfilesAsync()
    {       
        isLoading = true;

        try
        {
            var pagedResult = await DeveloperProvider.GetAllPagedProfilesAsync(currentPage, pageSize, searchTerm, selectedSortOption);
            profiles = pagedResult.Results.ToList();
            totalPages = pagedResult.PageCount;
            totalRows = pagedResult.RowCount;          
        }
        catch (Exception ex)
        {
            isLoading = false;
            Console.WriteLine($"Error loading profiles: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // Filtering
    private void ToggleFilterDropdown()
    {
        showFilterDropdown = !showFilterDropdown;
    }

    private async Task ApplySortOption(string option)
    {
        selectedSortOption = option;
        await LoadProfilesAsync();
    }

    private async Task ClearSortOption()
    {
        selectedSortOption = "";
        await LoadProfilesAsync();
    }
    private async Task FilterProfiles(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        profiles = allProfiles
    .Where(p =>
        (!string.IsNullOrEmpty(p.FirstName) && p.FirstName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
        (!string.IsNullOrEmpty(p.Surname) && p.Surname.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
        (!string.IsNullOrEmpty(p.Description) && p.Description.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)))
    .ToList();
    }

    // Paging
    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadProfilesAsync();
        }
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadProfilesAsync();
        }
    }
}
